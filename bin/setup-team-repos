#!/usr/bin/env sh
#
# Download every repo
#
# Usage: ./bin/setup-team-repo [<packages-path>]
# Without argument, will default to parent folder ("./../")
#

set -e

# Base folder, to locate mrconfig
repo_dir=$( dirname $0 )/..
# Where to checkout all packages
target_dir=$1

# Check before doing action
confirm_to_continue() {
  read -p "[?] Shall I proceed? [Y/n] " reply
  case "${reply}" in
  [Yy]|"")
    ;;
  *)
    echo "[-] Cancelling operation" >&2
    exit 0
    ;;
  esac
}

# Check myrepos is installed
if ! dpkg -s mr >/dev/null 2>/dev/null && ! dpkg -s myrepos >/dev/null 2>/dev/null; then
  echo "[-] Please 'sudo apt install mr' before running $0" >&2
  exit 1
fi

# No arguments, use default location of ../
if [ -z "${target_dir}" ]; then
  target_dir=$( realpath ${repo_dir}/.. )
fi
target_dir=$( realpath ${target_dir} )

# Create checkout location
mkdir -p "${target_dir}/"

# Feedback about action
echo "[>] I will setup '${target_dir}/.mrconfig' to easily checkout all repositories"
confirm_to_continue

# Copy myrepos config
cp "${repo_dir}/mrconfig" "${target_dir}/.mrconfig"
if [ ! -e ~/.mrtrust ] || ! grep -q "${target_dir}/.mrconfig" ~/.mrtrust; then
  echo "${target_dir}/.mrconfig" >>~/.mrtrust
fi

# Feedback about action
echo "[>] I will run 'mr --force checkout' to clone all repositories (in ${target_dir})"
confirm_to_continue

# Clone repos
cd "${target_dir}/"
mr --force \
   --verbose \
   --stats \
   checkout
