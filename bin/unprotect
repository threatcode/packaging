#!/usr/bin/env sh
#
# Will reset branch protection to allow developers to push and merge
#
# Usage: ./bin/unprotect [<package> ...]
# Without argument, will default to everything in https://gitlab.com/kalilinux/packages/
#

set -e

if [ -n "$1" ]; then
  projects="$@"
else
  ## 5034987 = https://gitlab.com/kalilinux/packages
  projects=$(salsa --conf-file ./salsa/auth.conf --group-id 5034987 ls | awk '/Name:/ {print $2}' | sort)
fi

for project in ${projects}; do
  echo "Setting branch protection for https://gitlab.com/kalilinux/packages/${project}"
  salsa --conf-file ./salsa/auth.conf --verbose --group-id 5034987 protect_branch ${project} kali/master no
  salsa --conf-file ./salsa/auth.conf --verbose --group-id 5034987 protect_branch ${project} kali/master d d
  echo ""
done
